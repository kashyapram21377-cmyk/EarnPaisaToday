<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel | Earn Paisa Today</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Segoe UI,Arial;
  background:#f4f6f8;
}
header{
  background:linear-gradient(135deg,#ff5722,#ff9800);
  color:#fff;
  padding:25px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.container{
  max-width:1300px;
  margin:40px auto;
  padding:0 20px;
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:24px;
}
.card{
  background:#fff;
  padding:20px;
  border-radius:18px;
  box-shadow:0 8px 25px rgba(0,0,0,.08);
}
h3{margin-top:0}
table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}
th,td{
  padding:8px;
  border-bottom:1px solid #eee;
  text-align:center;
}
th{background:#111;color:#fff}
button{
  padding:7px 14px;
  border:none;
  border-radius:20px;
  cursor:pointer;
  font-weight:600;
}
.approve{background:#16a34a;color:#fff}
.reject{background:#dc2626;color:#fff}
input,select,textarea{
  width:100%;
  padding:9px;
  margin:6px 0;
  border-radius:8px;
  border:1px solid #ccc;
}
.badge{
  padding:4px 10px;
  border-radius:12px;
  font-size:12px;
  color:#fff;
}
.pending{background:#f59e0b}
.approved{background:#16a34a}
.rejected{background:#dc2626}
.stat{
  font-size:26px;
  font-weight:700;
}
.delete{
  background:#000;
  color:#fff;
}
</style>
</head>

<body>

<header>
  <h2>üõ°Ô∏è Admin Dashboard</h2>
  <button onclick="logout()">Logout</button>
</header>

<div class="container">

<!-- ================= STATS ================= -->
<div class="grid">
  <div class="card">
    <h3>Total Users</h3>
    <div class="stat" id="totalUsers">0</div>
  </div>
  <div class="card">
    <h3>Total Earnings Given</h3>
    <div class="stat">‚Çπ<span id="totalEarnings">0</span></div>
  </div>
  <div class="card">
    <h3>Total Withdraw Approved</h3>
    <div class="stat">‚Çπ<span id="totalWithdraw">0</span></div>
  </div>
</div>

<br><br>

<!-- ================= USERS ================= -->
<div class="card">
<h3>üë§ Users</h3>
<table>
<thead><tr><th>Email</th><th>Balance</th></tr></thead>
<tbody id="userList"></tbody>
</table>
</div>

<br><br>

<!-- ================= ADD EARNING ================= -->
<div class="card">
<h3>‚ûï Add Earnings</h3>
<input id="earnUid" placeholder="User UID">
<input id="earnAmount" type="number" placeholder="Amount">
<input id="earnSource" placeholder="Source">
<button class="approve" onclick="addEarning()">Add</button>
<div id="earnMsg"></div>
</div>

<br><br>

<!-- ================= WITHDRAW ================= -->
<div class="card">
<h3>üí∏ Withdraw Requests</h3>
<table>
<thead>
<tr><th>Email</th><th>Amount</th><th>Status</th><th>Action</th></tr>
</thead>
<tbody id="withdrawList"></tbody>
</table>
</div>

<br><br>

<!-- ================= OFFERS ================= -->
<div class="card">
<h3>üî• Manage Offers</h3>
<div id="offers"></div>
</div>

<br><br>

<!-- ================= ADD OFFER ================= -->
<div class="card">
<h3>‚ûï Add New Offer</h3>
<input id="o_title" placeholder="Offer Title">
<input id="o_link" placeholder="Offer Link https://">
<select id="o_category">
<option value="">Select Category</option>
<option value="international">International</option>
<option value="affiliate">Affiliate</option>
<option value="survey">Survey</option>
<option value="finance">Finance</option>
</select>
<textarea id="o_desc" placeholder="Description"></textarea>
<label><input type="checkbox" id="o_active" checked> Active</label><br><br>
<button class="approve" onclick="addOffer()">Add Offer</button>
<div id="addMsg"></div>
</div>

</div>

<script>
const firebaseConfig={
  apiKey:"AIzaSyBwd7y4uG955kZ5eg91ryn8bzbWzK2R_Ks",
  authDomain:"earnpaisatoday.firebaseapp.com",
  projectId:"earnpaisatoday"
};
firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.firestore();

/* ===== ADMIN ROLE CHECK ===== */
auth.onAuthStateChanged(async user=>{
  if(!user){ location.href="login.html"; return; }

  const doc=await db.collection("users").doc(user.uid).get();
  if(!doc.exists || doc.data().role!=="admin"){
    alert("Admin only");
    auth.signOut();
    location.href="login.html";
    return;
  }

  loadStats();
  loadUsers();
  loadWithdraws();
  loadOffers();
});

/* ===== STATS ===== */
function loadStats(){
  db.collection("users").onSnapshot(snap=>{
    totalUsers.textContent=snap.size;
  });

  db.collection("earnings_history").onSnapshot(snap=>{
    let total=0;
    snap.forEach(d=> total+=d.data().amount||0);
    totalEarnings.textContent=total;
  });

  db.collection("withdraw_requests")
    .where("status","==","approved")
    .onSnapshot(snap=>{
      let total=0;
      snap.forEach(d=> total+=d.data().amount||0);
      totalWithdraw.textContent=total;
    });
}

/* ===== USERS ===== */
function loadUsers(){
  db.collection("users").onSnapshot(snap=>{
    userList.innerHTML="";
    snap.forEach(d=>{
      const u=d.data();
      userList.innerHTML+=`
      <tr>
        <td>${u.email||"-"}</td>
        <td>‚Çπ${u.balance||0}</td>
      </tr>`;
    });
  });
}

/* ===== ADD EARNING ===== */
function addEarning(){
  const uid=earnUid.value.trim();
  const amt=Number(earnAmount.value);
  const src=earnSource.value;

  if(!uid||amt<=0) return;

  db.collection("users").doc(uid).update({
    balance:firebase.firestore.FieldValue.increment(amt)
  });

  db.collection("earnings_history").add({
    uid,
    amount:amt,
    source:src,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  earnMsg.innerHTML="‚úÖ Added Successfully";
}

/* ===== WITHDRAW ===== */
function loadWithdraws(){
  db.collection("withdraw_requests").onSnapshot(snap=>{
    withdrawList.innerHTML="";
    snap.forEach(d=>{
      const w=d.data();
      withdrawList.innerHTML+=`
      <tr>
        <td>${w.userEmail}</td>
        <td>‚Çπ${w.amount}</td>
        <td><span class="badge ${w.status}">${w.status}</span></td>
        <td>${w.status==="pending"?`
          <button class="approve" onclick="updateWithdraw('${d.id}','approved',${w.amount},'${w.uid}')">Approve</button>
          <button class="reject" onclick="updateWithdraw('${d.id}','rejected')">Reject</button>`:"-"}</td>
      </tr>`;
    });
  });
}

function updateWithdraw(id,status,amt,uid){
  db.collection("withdraw_requests").doc(id).update({status});
  if(status==="approved"){
    db.collection("users").doc(uid)
    .update({balance:firebase.firestore.FieldValue.increment(-amt)});
  }
}

/* ===== OFFERS ===== */
function loadOffers(){
  db.collection("offers").onSnapshot(snap=>{
    offers.innerHTML="";
    snap.forEach(doc=>{
      const d=doc.data();
      offers.innerHTML+=`
      <div class="card" style="margin-bottom:15px">
        <b>${d.title}</b> (${d.category})<br><br>
        <button onclick="toggleOffer('${doc.id}',${d.active})"
        style="background:${d.active?'#16a34a':'#dc2626'};color:#fff">
        ${d.active?'ON':'OFF'}
        </button>
        <button class="delete"
        onclick="deleteOffer('${doc.id}')">Delete</button>
      </div>`;
    });
  });
}

function toggleOffer(id,state){
  db.collection("offers").doc(id).update({active:!state});
}

function deleteOffer(id){
  if(confirm("Delete this offer?")){
    db.collection("offers").doc(id).delete();
  }
}

function addOffer(){
  if(!o_title.value||!o_link.value||!o_category.value) return;

  db.collection("offers").add({
    title:o_title.value,
    link:o_link.value,
    category:o_category.value,
    description:o_desc.value,
    active:o_active.checked,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  addMsg.innerHTML="‚úÖ Offer Added";
}

function logout(){
  auth.signOut().then(()=>location.href="index.html");
}
</script>

</body>
</html>
